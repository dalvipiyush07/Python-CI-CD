pipeline {
  agent any

  environment {
    REMOTE_HOST = "13.204.86.75"
    REMOTE_USER = "ubuntu"
    REMOTE_DIR  = "/home/ubuntu/learnhub-app"
    APP_PORT    = '5000'
    PYTHON      = "${REMOTE_DIR}/venv/bin/python3"
    GUNICORN    = "${REMOTE_DIR}/venv/bin/gunicorn"
    # Optional: set number of gunicorn workers
    GUNICORN_WORKERS = '2'
  }

  options {
    timeout(time: 20, unit: 'MINUTES')
    buildDiscarder(logRotator(daysToKeepStr: '14', numToKeepStr: '20'))
    ansiColor('xterm')
  }

  stages {
    stage('Clone') {
      steps {
        echo 'Cloning repository from GitHub...'
        git url: 'https://github.com/dalvipiyush07/Python-CI-CD.git', branch: 'main', credentialsId: 'node-app-key'
      }
    }

    stage('Verify Files') {
      steps {
        echo 'Verifying project files...'
        sh 'ls -la || true'
        sh "test -f app.py && echo '✓ app.py found' || { echo '✗ app.py missing'; exit 1; }"
        sh "test -f requirements.txt && echo '✓ requirements.txt found' || { echo '✗ requirements.txt missing'; exit 1; }"
      }
    }

    stage('Lint') {
      steps {
        echo 'Running lint checks (best-effort)...'
        sh '''
          python3 -m pip install --user flake8 || true
          python3 -m flake8 app.py --max-line-length=120 --ignore=E501,W503 || true
          echo '✅ Lint completed (non-blocking)'
        '''
      }
    }

    stage('Deploy Files') {
      steps {
        echo 'Copying files to remote host...'
        sshagent(credentials: ['node-app-key']) {
          sh """
            scp -o StrictHostKeyChecking=no app.py requirements.txt ${REMOTE_USER}@${REMOTE_HOST}:${REMOTE_DIR}/ || { echo '❌ scp failed'; exit 1; }
          """
        }
      }
    }

    stage('Prepare Remote') {
      steps {
        echo 'Preparing remote environment (venv, packages, essentials)...'
        sshagent(credentials: ['node-app-key']) {
          sh """
            ssh -o StrictHostKeyChecking=no ${REMOTE_USER}@${REMOTE_HOST} 'bash -s' <<'EOF'
              set -e
              sudo apt-get update -y || true
              # Ensure essential tools exist (ss comes with iproute2, curl required for health checks)
              sudo apt-get install -y --no-install-recommends iproute2 curl || true

              mkdir -p ${REMOTE_DIR}
              cd ${REMOTE_DIR}

              # recreate venv to avoid stale environments
              if [ -d venv ]; then rm -rf venv; fi
              python3 -m venv venv
              ./venv/bin/python3 -m pip install --upgrade pip
              ./venv/bin/python3 -m pip install -r requirements.txt

              echo '✅ Remote preparation done'
            EOF
          """
        }
      }
    }

    stage('Stop App (if any)') {
      steps {
        echo 'Stopping any existing app processes...'
        sshagent(credentials: ['node-app-key']) {
          sh """
            ssh -o StrictHostKeyChecking=no ${REMOTE_USER}@${REMOTE_HOST} 'bash -s' <<'EOF'
              set -e || true
              if pgrep -f "python.*app.py|gunicorn" > /dev/null 2>&1; then
                pkill -f "python.*app.py|gunicorn" || true
                sleep 2
              fi
              echo '✅ Stop attempted'
            EOF
          """
        }
      }
    }

    stage('Start App') {
      steps {
        echo 'Starting application (uses venv python by default; will fallback to gunicorn if requested)...'
        sshagent(credentials: ['node-app-key']) {
          sh """
            ssh -o StrictHostKeyChecking=no ${REMOTE_USER}@${REMOTE_HOST} 'bash -s' <<'EOF'
              set -e
              cd ${REMOTE_DIR}

              # Prefer gunicorn if installed (production-like), else fallback to venv python
              if [ -x "${GUNICORN}" ]; then
                echo "Starting with gunicorn: ${GUNICORN} -w ${GUNICORN_WORKERS} -b 0.0.0.0:${APP_PORT} app:app"
                nohup ${GUNICORN} -w ${GUNICORN_WORKERS} -b 0.0.0.0:${APP_PORT} app:app > app.log 2>&1 &
              else
                echo "Starting with venv python: ${PYTHON} app.py"
                nohup ${PYTHON} app.py > app.log 2>&1 &
              fi

              sleep 4
              echo "PID(s):"
              ps aux | egrep "python.*app.py|gunicorn" | grep -v grep || true
              echo '---- tail app.log (last 10) ----'
              tail -n 10 app.log || true
            EOF
          """
        }
      }
    }

    stage('Verify') {
      steps {
        echo 'Verifying app is listening and healthy...'
        sshagent(credentials: ['node-app-key']) {
          sh """
            ssh -o StrictHostKeyChecking=no ${REMOTE_USER}@${REMOTE_HOST} 'bash -s' <<'EOF'
              set -e

              # check process
              if ! pgrep -f 'python.*app.py|gunicorn' > /dev/null; then
                echo '✗ Application process not found'
                tail -n 200 app.log || true
                exit 1
              fi
              echo '✓ Process running'

              # check port using ss
              if ss -tuln | grep -q ':${APP_PORT}'; then
                echo '✓ Port ${APP_PORT} listening'
              else
                echo '✗ Port ${APP_PORT} not listening'
                tail -n 200 app.log || true
                exit 1
              fi

              # health endpoint test (localhost)
              if curl -sSf http://127.0.0.1:${APP_PORT}/ >/dev/null; then
                echo '✓ HTTP health check passed'
              else
                echo '✗ HTTP health check failed'
                tail -n 200 app.log || true
                exit 1
              fi

              echo '✅ Verification complete'
            EOF
          """
        }
      }
    }

    stage('Display Info') {
      steps {
        echo 'App info:'
        sshagent(credentials: ['node-app-key']) {
          sh """
            ssh -o StrictHostKeyChecking=no ${REMOTE_USER}@${REMOTE_HOST} 'bash -s' <<'EOF'
              echo "URL: http://${REMOTE_HOST}:${APP_PORT}"
              echo "PID(s):"
              pgrep -a -f "python.*app.py|gunicorn" || true
              echo "Last 100 lines of logs:"
              tail -n 100 app.log || true
            EOF
          """
        }
      }
    }
  }

  post {
    always {
      echo 'Pipeline done'
    }
    success {
      echo "✅ Deployment successful — http://${REMOTE_HOST}:${APP_PORT}"
    }
    failure {
      echo '❌ Deployment failed — collecting logs...'
      sshagent(credentials: ['node-app-key']) {
        sh """
          ssh -o StrictHostKeyChecking=no ${REMOTE_USER}@${REMOTE_HOST} 'bash -s' <<'EOF'
            echo '---- app.log ----'
            [ -f app.log ] && tail -n 500 app.log || echo 'No app.log'
          EOF
        """
      }
    }
  }
}
